---
title: "Expectation Maximization for Gaussian Clustering"
output: html_notebook
---

```{r}
library(ggplot2)
```

```{r}
generate_sample_data <- function(sample_size, mu, sigma, k) {
  sample_data <- c()
  for(i in seq(1:k)) {
    sample_data <- c(sample_data, rnorm(n = sample_size/i, mean = mu[i], sd = sigma[i]))
  }
  return(sample_data)
}
```

```{r}
k <- 3
mu <- c(3, 5, 12)
sigma <- c(1, 2, 2)
```

```{r}
set.seed(123)
sample_size <- 100
sample_data <- generate_sample_data(sample_size, mu, sigma, k)
```

```{r}
hist(sample_data)
```

```{r}
E_step <- function(sample_data, mu, sigma, k) {
  
  sample_size <- length(sample_data)
  
  denominator <- matrix(0, 1, sample_size)
  for(i in seq(1:k)) {
    denominator <- denominator + (1 / k) * exp(-(sample_data - mu[i]) ^ 2 / 2 * sigma[i] ^ 2)  / (sqrt(2 * pi) * sigma[i])
  }
  
  Gaussian_likelihoods <- matrix(0, sample_size, k)
  
  for(i in seq(1:k)) {
    Gaussian_likelihoods[, i] <- (1 / k) * (exp(-(sample_data - mu[i]) ^ 2 / 2 * sigma[i] ^ 2)  / (sqrt(2 * pi) * sigma[i])) / denominator
  }
  
  return(Gaussian_likelihoods)
}
```

```{r}
k <- 3
mu0 <- c(2, 3, 7)
sigma0 <- c(1, 1, 1)
```

```{r}
Gaussian_likelihoods <- E_step(sample_data, mu, sigma, k)
head(Gaussian_likelihoods)
```

```{r}
expected_Gaussians <- matrix(0, length(Gaussian_likelihoods), 1)
expected_Gaussians <- max.col(Gaussian_likelihoods, ties.method = "first")
print(expected_Gaussians)
```

```{r}
M_step <- function(sample_data, expected_Gaussians, k) {
  
  sample_size <- length(sample_data)
  next_mu <- matrix(0, k, 1)
  next_sigma <- matrix(0, k, 1)
  
  get_all_max <- function(vector) {as.data.frame(table(vector))}
  Gaussian_cluster <- matrix(0, k, )
  for(i in seq(1:k)) {
    Gaussian_cluster[i, ] <- t(sample_data[expected_Gaussians == i]) # Data estimated to belong to Gaussian number i
    
    next_mu[i] <- mean(Gaussian_cluster[i, ])
    next_sigma[i] <- sqrt(sum((Gaussian_cluster[i, ] - next_mu[i]) ^ 2) / length(Gaussian_cluster[i, ]))
  }
  
  parameter_estimates <- list(next_mu, next_sigma)
  names(parameter_estimates) <- c("Next_Mu", "Next_Sigma")
  
  estimates_and_clusters <- list(parameter_estimates, Gaussian_cluster)
  
  return(estimates_and_clusters)
}
```

```{r}
estimates_and_clusters <- M_step(sample_data, expected_Gaussians, k)
print(estimates_and_clusters))
```

```{r}
plot <- ggplot(data.frame(sample_data), aes(x = sample_data)) + 
        geom_histogram(data = data.frame(sample_data), binwidth = 1, colour = "black")
for(i in seq(1:k)) {
  plot <- plot + 
          stat_function(fun = dnorm, color = "red", 
                        args = list(mean = parameter_estimates$Next_Mu[i], sd = parameter_estimates$Next_Sigma[i]))
  
}
print(plot)
```

```{r}
Expectation_Maximum_Iteration(sample_data, mu, sigma, k, no_of_iterations) {
  
  for(i in seq(1:no_of_iterations)) { # To be replaced with convergence check
    Gaussian_likelihoods <- E_step(sample_data, mu, sigma, k)
    
    expected_Gaussians <- matrix(0, length(Gaussian_likelihoods), 1)
    expected_Gaussians <- max.col(Gaussian_likelihoods, ties.method = "first")
    
    parameter_estimates <- M_step(sample_data, expected_Gaussians, k)
    mu <- parameter_estimates$Next_Mu
    sigma <- parameter_estimates$Next_Sigma
  }
  
  return(parameter_estimates)
}
```

```{r}

```

